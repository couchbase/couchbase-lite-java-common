//
// Copyright (c) 2022 Couchbase, Inc All rights reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
// http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//
package com.couchbase.lite

import org.junit.Assert.assertEquals
import org.junit.Assert.assertNotNull
import org.junit.Assert.assertNotSame
import org.junit.Assert.assertNull
import org.junit.Test


class DbCollectionsTest : BaseCollectionTest() {
    @Test
    fun testGetDefaultScope() {
        val scope = baseTestDb.defaultScope
        assertEquals(Scope.DEFAULT_NAME, scope.name)
        assertEquals(1, scope.collectionCount)
        assertNotNull(scope.getCollection(Collection.DEFAULT_NAME))
    }

    @Test
    //create valid collections
    fun testCreateCollectionInDefaultScope() {
        //name with valid characters
        baseTestDb.createCollection("chintz")
        // collection names should be case sensitive
        baseTestDb.createCollection("Chintz")
        baseTestDb.createCollection("6hintz")
        baseTestDb.createCollection("-Ch1ntz")

        val scope = baseTestDb.defaultScope
        assertEquals(5, scope.collectionCount)
        assertNotNull(scope.getCollection("chintz"))
        assertNotNull(scope.getCollection("Chintz"))
        assertNotNull(scope.getCollection("6hintz"))
        assertNotNull(scope.getCollection("-Ch1ntz"))
    }


    @Test(expected = CouchbaseLiteException::class)
    fun testCollectionNameStartWithIllegalChars1() {
        baseTestDb.createCollection("_notvalid")
    }

    @Test(expected = CouchbaseLiteException::class)
    fun tesCollectionNameStartWithIllegalChars2() {
        baseTestDb.createCollection("%notvalid")
    }

    @Test(expected = CouchbaseLiteException::class)
    fun testCollectionNameContainingIllegalChars() {
        baseTestDb.createCollection("notval!d")
    }

    @Test
    fun testCreateCollectionInNamedScope() {
        baseTestDb.createCollection("chintz", "micro")
        baseTestDb.createCollection("chintz", "3icro")
        baseTestDb.createCollection("chintz", "-micro")

        var scope: Scope? = baseTestDb.defaultScope
        assertEquals(1, scope?.collectionCount)
        assertNull(scope?.getCollection("chintz"))

        scope = baseTestDb.getScope("micro")
        assertEquals(1, scope?.collectionCount)
        assertNotNull(scope?.getCollection("chintz"))

        scope = baseTestDb.getScope("3icro")
        assertEquals(1, scope?.collectionCount)
        assertNotNull(scope?.getCollection("chintz"))


        scope = baseTestDb.getScope("-micro")
        assertEquals(1, scope?.collectionCount)
        assertNotNull(scope?.getCollection("chintz"))

    }

    @Test(expected = CouchbaseLiteException::class)
    fun testScopeNameWithIllegalChar1() {
        baseTestDb.createCollection("chintz", "_micro")
    }

    @Test(expected = CouchbaseLiteException::class)
    fun testScopeNameWithIllegalChar2() {
        baseTestDb.createCollection("chintz", "%micro")
    }

    @Test
    fun testScopeNameCaseSensitive() {
        baseTestDb.createCollection("coll1", "scope1")
        val scope1 = baseTestDb.getScope("scope1")

        baseTestDb.createCollection("coll2", "Scope1")
        val scope2 = baseTestDb.getScope("Scope1")

        assertNotNull(scope1)
        assertNotNull(scope2)
        assertEquals(scope1, baseTestDb.getScope("scope1"))
        assertNotSame(scope1, scope2)
    }

    @Test
    fun testGetScopes() {
        val scopes = baseTestDb.scopes
        assertEquals(2, scopes.size)

        var scope = scopes.first { it.name == Scope.DEFAULT_NAME }
        assertNotNull(scope.getCollection(Scope.DEFAULT_NAME))

        scope = scopes.first { it.name == testScopeName }
        assertNotNull(scope.getCollection(testColName))
    }

    @Test
    fun testDeleteCollectionFromNamedScope() {
        var scopes = baseTestDb.scopes
        assertEquals(2, scopes.size)

        baseTestDb.deleteCollection(testColName, testScopeName)

        scopes = baseTestDb.scopes
        assertEquals(1, scopes.size)
    }


    // !!! TESTS BELOW NEED TO BE MOVED TO CollectionTest

    @Test
    fun testDeleteDefaultCollection() {
        var scopes = baseTestDb.scopes

        // scopes should have a default scope and a non default test scope created in BaseCollection
        assertEquals(2, scopes.size)

        var scope = baseTestDb.defaultScope
        assertEquals(1, scope.collectionCount)

        baseTestDb.deleteCollection(Collection.DEFAULT_NAME)

        // The default collection should not go away when it is empty
        scopes = baseTestDb.scopes
        assertEquals(2, scopes.size)
        assertNotNull(baseTestDb.defaultScope)

        scope = baseTestDb.defaultScope
        assertEquals(0, scope.collectionCount)
    }

    /**
     * Collections and Cross Database instance
     */

    @Test
    fun testCreateThenGetCollectionFromDifferentDatabaseInstance() {
        val otherDb = duplicateDb(baseTestDb)
        try {
            baseTestDb.createCollection("testColl")
            val collection = otherDb.getCollection("testColl")
            assertNotNull(collection)

            //delete coll from a db
            baseTestDb.deleteCollection("testColl")
            assertNull(baseTestDb.getCollection("testColl"))
            assertNull(otherDb.getCollection("testColl"))

            //recreate collection
            baseTestDb.createCollection("testColl")
            val collectionRecreated = otherDb.getCollection("testColl")
            assertNotSame(collectionRecreated, collection)
        } finally {
            deleteDb(otherDb)
        }
    }

    @Test
    fun testCreateCollectionFromDifferentDatabase() {
        //open a new db
        val newDB = openDatabase()
        try {
            assertNull(newDB.getCollection(testColName, testScopeName))
        } finally {
            // delete otherDb
            deleteDb(newDB)
        }
    }
}

